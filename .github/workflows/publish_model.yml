name: Publish Model to Hugging Face

on:
  push:
    tags:
      - '*'

permissions:
  contents: read

jobs:
  publish:
    name: Push Weights to Hugging Face
    runs-on: [self-hosted, linux, x64]
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Extract tag name and short SHA
        id: meta
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          SHA="$(git rev-parse --short HEAD)"
          echo "tag=$TAG"   >> $GITHUB_OUTPUT
          echo "sha=$SHA"   >> $GITHUB_OUTPUT
          echo "Tag: $TAG"
          echo "Short SHA: $SHA"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r publish/requirements.txt

      - name: Push model to Hugging Face
        run: |
          python publish/push_to_hf.py \
            --s3-path "s3://${{ secrets.S3_BUCKET }}/outputs/checkpoints/${{ steps.meta.outputs.sha }}/model.pt" \
            --repo-id "${{ github.repository_owner }}/g1-${{ steps.meta.outputs.tag }}"
