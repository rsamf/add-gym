name: Train Model on SageMaker

on:
  push:
    branches:
      - models
      - models/*

permissions:
  contents: read

jobs:
  train:
    name: Build and Submit Training Job
    runs-on: [self-hosted, linux, x64]
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Mask ECR registry URL
        run: echo "::add-mask::${{ steps.login-ecr.outputs.registry }}"

      - name: Calculate Short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push to ECR
        uses: docker/build-push-action@v5
        with:
          push: true
          build-args: |
            BASE_IMAGE=${{ secrets.BASE_IMAGE }}
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/add-gym:${{ steps.short-sha.outputs.sha }}
            ${{ steps.login-ecr.outputs.registry }}/add-gym:latest
          cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/add-gym:latest
          cache-to: type=inline

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3 pyyaml

      - name: Submit SageMaker Training Job
        env:
          SHORT_SHA: ${{ steps.short-sha.outputs.sha }}
        run: |
          python deploy/submit_sagemaker_job.py \
            --job-name $SHORT_SHA \
            --aws-region $AWS_REGION \
            --image-uri "${{ steps.login-ecr.outputs.registry }}/add-gym:$SHORT_SHA" \
            --s3-bucket ${{ secrets.S3_BUCKET }} \
            --config deploy/sagemaker-job-config.yaml \
            --hydra-config deploy/train-config.yaml
